#Libraries
```{r}
library(dplyr)
library(tibble)
library(tidyr)
library(readxl)
library(stringr)
library(corrplot)
library(ggplot2)
library(car)
```

# Load H1b 2022 and 2023:
```{r message = FALSE, warning = FALSE}
fy22 <- read_excel('dataset/Perm_data/PERM_Disclosure_Data_FY2022_Q4.xlsx')
fy23 <- read_excel('dataset/Perm_data/PERM_Disclosure_Data_FY2023_Q4.xlsx')
```

# Load IMF data: GDP per capita and Unemployment
```{r}
imf_gdpc_usd_raw <- read_excel('dataset/IMF_data/imf_gdp_per_capita_usd.xls')
imf_unemployment_raw <- read_excel('dataset/IMF_data/imf_unemployment.xls')
names(imf_gdpc_usd_raw)[1] <- "Country"
names(imf_unemployment_raw)[1] <- "Country"
```

# Country name standardization function
```{r}
standardize_country_names <- function(countries) {
  countries %>%
    tolower() %>%
    str_replace_all("burma", "myanmar") %>%
    str_replace_all("cape verde", "cabo verde") %>%
    str_replace_all("hong kong sar", "hong kong") %>%
    str_replace_all("islamic republic of iran", "iran") %>%
    str_replace_all("kyrgyz republic", "kyrgyzstan") %>%
    str_replace_all("lao p.d.r.", "laos") %>%
    str_replace_all("macao sar", "macau") %>%
    str_replace_all("north macedonia", "macedonia") %>%
    str_replace_all("russian federation", "russia") %>%
    str_replace_all("korea, republic of", "south korea") %>%
    str_replace_all("taiwan province of china", "taiwan") %>%
    str_replace_all("united republic of tanzania", "tanzania") %>%
    str_replace_all("türkiye, republic of", "turkey") %>%
    str_replace_all("united kingdom", "great britain") %>%
    str_replace_all("bolivarian republic of venezuela", "venezuela") %>%
    str_replace_all("congo, dem. rep. of the", "democratic republic of congo") %>%
    str_replace_all("slovak republic", "slovakia") %>%
    str_replace_all("st lucia", "saint lucia") %>%
    str_replace_all("st vincent", "saint vincent and the grenadines") %>%
    str_replace_all("sri lanka", "sri lanka") %>%
    str_replace_all("bahamas, the", "bahamas") %>%
    str_replace_all("gambia, the", "gambia") %>%
    str_replace_all("myanmar \\(myanmar\\)", "myanmar") %>%
    str_replace_all("united states of america", "united states") %>%
    str_replace_all("china, people's republic of", "china") %>%
    str_replace_all("cote d'ivoire", "côte d'ivoire" )
}
# TESTING

# h1b_countries <- unique(h1b_stacked$COUNTRY_OF_CITIZENSHIP)
# imf_countries <- union(imf_gdpc_usd_raw$Country, imf_unemployment_raw$Country)
# 
# h1b_countries_standardized <- standardize_country_names(h1b_countries)
# imf_countries_standardized <- standardize_country_names(imf_countries)
# 
# countries_matched_inner <- intersect(h1b_countries_standardized, imf_countries_standardized)
# countries_matched_full <- union(h1b_countries_standardized, imf_countries_standardized)
# countries_h1b_left <- setdiff(h1b_countries_standardized, imf_countries_standardized)
# countries_imf_left <- setdiff(imf_countries_standardized, h1b_countries_standardized)
# print(length(countries_matched_inner))
# print(length(countries_matched_full))
# print(countries_h1b_left)
# print(countries_imf_left)
```

# Clean and stack H1b 2022 and 2023
```{r}
process_data <- function(df, relevant_columns) {
  df <- df %>%
    filter(CLASS_OF_ADMISSION == 'H-1B', CASE_STATUS == 'Certified') %>%
    select(all_of(relevant_columns))
  df$Country_Standardized <- standardize_country_names(df$COUNTRY_OF_CITIZENSHIP)
  df <- select(df, -COUNTRY_OF_CITIZENSHIP)
  return (df)
}
relevant_columns <- c("WAGE_OFFER_FROM", "COUNTRY_OF_CITIZENSHIP", "FOREIGN_WORKER_EDUCATION")
fy22_cleaned <- process_data(fy22, relevant_columns)
fy23_cleaned <- process_data(fy23, relevant_columns)
h1b_stacked <- rbind(fy22_cleaned, fy23_cleaned)
fy22_cleaned
fy23_cleaned
h1b_stacked
```

#Notes:
Case_status : Certified, Certified-Expired, Denied, Withdrawn
Foreign_worker_education: Master's, Bachelor's, Doctorate, Other, None, Associate's, High School


# Clean and backfill IMF data: GDP per capita and Unemployment
```{r}
backfill_leftward <- function(df) {
  names(df)[1] <- "Country"
  df[df == "no data"] <- NA
  df <- df %>% filter(!is.na(Country))
  df_long <- df %>%
    pivot_longer(
      !Country, 
      names_to = "Year",
      values_to = "Value"
    )
  df_filled <- df_long %>%
    group_by(Country) %>%
    fill(Value, .direction = "down") %>%
    ungroup()
  df_wide <- df_filled %>%
    pivot_wider(
      names_from = Year,
      values_from = Value
    )
  df_wide <- mutate(df_wide, across(c("2022", "2023"), as.numeric))
  if("2022" %in% names(df_wide) && "2023" %in% names(df_wide)) {
    df_wide <- df_wide %>%
      mutate(Average_2022_2023 = rowMeans(select(., c("2022", "2023")), na.rm = TRUE))
  }
  df_wide <- df_wide %>%
    mutate(Country_Standardized = standardize_country_names(Country)) %>%
    select(Country_Standardized, Average_2022_2023)
  return(df_wide)
}
imf_gdpc_usd <- imf_gdpc_usd_raw %>%
  slice(1:(nrow(.)-34)) %>%
  backfill_leftward()
imf_unemployment <- imf_unemployment_raw %>%
  slice(1:(nrow(.)-6)) %>%
  backfill_leftward()
imf_gdpc_usd
imf_unemployment
```

# Mutate IMF columns into H1b
```{r warning=FALSE}
h1b_final <- h1b_stacked %>%
  left_join(imf_gdpc_usd, by = "Country_Standardized") %>%
  left_join(imf_unemployment, by = "Country_Standardized") %>%
  na.omit() %>%
  setNames(c("Wage", "Education", "Country", "GDP per capita", "Unemployment"))
h1b_final
```

# Correlation heatmap
```{r}
data_for_heatmap <- h1b_final %>%
  select(-Country, -Education) %>%
  na.omit()
cor_matrix <- cor(data_for_heatmap)
corrplot(cor_matrix, method = "color", type = "upper", order = "hclust",
         tl.col = "black", tl.srt = 45, title = "Correlation Heatmap", addCoef.col = "black", number.cex=0.8)
```

# Linear regression model 1: Wage ~ GDP per capita + Unemployment (without outlier treatment)
```{r}
model <- lm(Wage ~ `GDP per capita` + Unemployment, data = h1b_final)
summary(model)
```

# Visualization of linreg 1
```{r}
ggplot(h1b_final, aes(x = independent_var, y = dependent_var)) +
  geom_point() +  # Add points
  geom_smooth(method = "lm", se = TRUE, color = "red") +  # Add regression line with standard error
  labs(title = "Regression Analysis", x = "Independent Variable", y = "Dependent Variable")
```

# Model diagnostics for linreg 1
```{r}
vif(model)
par(mfrow = c(2, 2))
plot(model)
```

# Treating linreg 1 outlier
```{r}
cooks_distances <- cooks.distance(model)
outliers <- which(cooks_distances > 0.5)
print(outliers)
print(h1b_final[outliers, ]) # 6.5 million usd is likely to be an outlier
h1b_final_no_outlier <- h1b_final[-outliers, ]
```

# Linear regression model 2: Wage ~ GDP per capita + Unemployment (with outlier treatment)
```{r}
model <- lm(Wage ~ `GDP per capita` + Unemployment, data = h1b_final_no_outlier)
summary(model)
```

# Model diagnostics for linreg 2
```{r}
vif(model)
par(mfrow = c(2, 2))
plot(model)
```

