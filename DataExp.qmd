<<<<<<< HEAD
```{r}
library(viridis)

```

```{r}
suppressPackageStartupMessages(library(tidyverse))
#filename <- file.choose("cleaned_h1b_data.rds")
#print(filename)
h1b_country <- 
  read_rds('dataset/cleaned_h1b_data.rds')
```

```{r}
h1b_country
```

```{r}
#changing the year to numerical values
current_names <- names(h1b_country)

colnames(h1b_country) <- c('Country','Continent','1997', '1998', '1999', '2000', '2001', '2002', '2003', '2004', '2005', '2006', '2007', '2008', '2009', '2010', '2011', '2012', '2013', '2014', '2015', '2016', '2017', '2018', '2019', '2020', '2021', '2022')

data_long <- pivot_longer(h1b_country, cols = -c("Continent", "Country"), names_to = "year", values_to = "count_h1b")
```

```{r}
data_long
```

```{r}
h1b_continent <- h1b_country |>
  group_by(Continent)|>
  select(-Country)|>
  summarize(across(everything(), sum, na.rm = TRUE))

library(tidyr)
data_long <- pivot_longer(h1b_continent, cols = -Continent, names_to = "year", values_to = "count_h1b")

data_long
```


Goal: Explore relationship between number of applications and wages
```{r}
library(readxl)
library(readr)
library(dplyr)
library(tidymodels)
library(cluster)
library(ggplot2)
library(lubridate)
```

```{r}
df <- readRDS("dataset/cleaned_disclosure.rds")
head(df)
```

```{r}
df_merged <- readRDS("dataset/final_merge.rds")
```

```{r}
df_merged
```
```{r}
final_df <- readRDS("dataset/final_merge.rds")
```

#1. Group by company
#2. Compare rates per company
#3. Linear relationship between number of applications and wages, by company

```{r}
filtered_data <- final_df |>
  filter(FULL_TIME_POSITION == "Y") |>
  mutate(JOB_TITLE = tolower(JOB_TITLE)) |>
  count(JOB_TITLE, sort = TRUE)

print(filtered_data |> top_n(5))
```


```{r}
filtered_data <- final_df |>
  count(EMPLOYER_NAME, sort = TRUE)

print(filtered_data |> top_n(5))
```


```{r}
final_df$YEAR_RECEIVED = as.integer(substr(final_df$RECEIVED_DATE, 1, 4))
final_df$MONTH_RECEIVED = month(final_df$RECEIVED_DATE)
final_df$DAY_RECEIVED = day(final_df$RECEIVED_DATE)
final_df$YEAR_END = as.integer(substr(final_df$END_DATE, 1, 4))
final_df$MONTH_END = month(final_df$END_DATE)
final_df$DAY_END = day(final_df$END_DATE)

final_df$YEAR_DECISION = as.integer(substr(final_df$DECISION_DATE, 1, 4))
final_df$MONTH_DECISION = month(final_df$DECISION_DATE)
final_df$DAY_DECISION = day(final_df$DECISION_DATE)


final_df$YEAR_BEGIN = as.integer(substr(final_df$BEGIN_DATE, 1, 4))
final_df$MONTH_BEGIN = month(final_df$BEGIN_DATE)
final_df$DAY_BEGIN = day(final_df$BEGIN_DATE)
```

```{r}
top_5_employer <- final_df |>
  group_by(EMPLOYER_NAME, YEAR_BEGIN)|>
  
  count(EMPLOYER_NAME, sort = TRUE) |>
  top_n(5)
head(top_5_employer)
```


```{r}
top_5_summarise <- top_5_employer |>
  group_by(YEAR_BEGIN, EMPLOYER_NAME) |>
  mutate(count_h1b = n())
```

```{r}
head(top_5_summarise)
```

```{r}
# unique(top_5_summarise$EMPLOYER_NAME)
```



```{r}
# comment for now, stuck in an infinite loop?

#ggplot(top_5_summarise, aes(x = YEAR_BEGIN, y = count_h1b, fill = EMPLOYER_NAME)) +
 # geom_bar(stat = "identity", position = "stack") +
  #facet_wrap(~EMPLOYER_NAME)+
  #labs(title = "Total H1b Visas by Company Over the Years",
   #    x = "Year", y = "Total Value") + theme(legend.position = "",
    #    axis.text.x = element_text(angle = 45, hjust = 1))
```

```{r}
summary_data <- final_df %>%
  group_by(EMPLOYER_NAME, YEAR_BEGIN, WAGE_UNIT_OF_PAY, WAGE_RATE_OF_PAY_FROM) %>%
  filter(!is.na(WAGE_RATE_OF_PAY_FROM))|>
  filter(PW_UNIT_OF_PAY == 'Year')|>
  mutate(applications = n(), avg_wage = mean(WAGE_RATE_OF_PAY_FROM))
```

```{r}
nrow(summary_data)
nrow(final_df)
```

```{r}
head(summary_data)
summary(summary_data)
```


```{r}
correlation <- cor(summary_data$applications, summary_data$avg_wage)
```

```{r}
correlation
```

Goal: Financial Info with countries


```{r}
ggplot(data_long, aes(x = year, y = count_h1b, fill = Continent)) +
  geom_bar(stat = "identity", position = "stack") +
  labs(title = "Total Values by Continent Over the Years",
       x = "Year", y = "Total Value") + theme(legend.position = "top",
        axis.text.x = element_text(angle = 45, hjust = 1))
```

```{r}
ggplot(data_long, aes(x = year, y = count_h1b, fill = Continent)) +
  geom_bar(stat = "identity", position = "stack") +
  facet_wrap(~Continent, scales='free_y') + 
  labs(title = "Total Values by Continent Over the Years",
       x = "Year", y = "Number of Applications") + theme(legend.position = "none",
        axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_x_discrete(guide=guide_axis(check.overlap=TRUE))
```


```{r}
h1b_continent <- h1b_country |>
  filter(Continent == 'Unknown') |>
  select(-Continent)

# library(tidyr)
unknown_longer <- pivot_longer(h1b_continent, cols = -Country, names_to = "year", values_to = "count_h1b")
# 
unknown_longer
```

```{r}
names(unknown_longer)
```


```{r}
clean_un <- unknown_longer |>
  filter(Country == 'United Nations Laissez-Passer')|>
  filter(count_h1b != 0)

clean_un
```
This shows that no one with a nationality designated as 'United Nations Laissez-Passer' has received an h1b visa from the years 1997-2022, so we can clear that.

```{r}
ggplot(unknown_longer, aes(x = year, y = count_h1b, fill = Country)) +
  geom_bar(stat = "identity", position = "stack") +
  #facet_wrap(~Continent, scales='free_y')+
  labs(title = "Total Values by Continent Over the Years",
       x = "Year", y = "Total Value") + theme(legend.position = "top",
        axis.text.x = element_text(angle = 45, hjust = 1))
```





```{r}
#do the same for other continents

h1b_asia <- h1b_country |>
  filter(Continent == 'Asia') |>
  select(-Continent)
  #summarize(across(where(is.numeric), sum, na.rm = TRUE))

data_long_asia <- pivot_longer(h1b_asia, cols=-Country, names_to = "year", values_to = "count_h1b")

piecharts_asia <- list()

for(year_iter in unique(data_long_asia$year)){
  print(year_iter)
  asia_temp <- data_long_asia |> filter(year == year_iter)
  
  #choose top 5
  top_countries <- asia_temp |>
  group_by(Country) |>
  summarise(total_count = count_h1b) |>
  arrange(desc(total_count)) |>
  top_n(5)
  
  #summarise the rest
  other_countries <- asia_temp |>
  anti_join(top_countries, by = "Country") |>
    filter(!is.na(count_h1b))|>
  summarise(Country = "Other",
            total_count = sum(count_h1b))
  
  combined_data <- bind_rows(top_countries, other_countries)
  pie_chart <- pie(combined_data$total_count, labels = combined_data$Country, main = paste("Top 5 Asian Countries in", year_iter), col=viridis(length(combined_data$total_count)))
  
  piecharts_asia[[year_iter]] <- pie_chart
  
}
print(piecharts_asia)
```


```{r}

#do the same for other continents
h1b_europe <- h1b_country |>
  filter(Continent == 'Europe') |>
  select(-Continent)
  #summarize(across(where(is.numeric), sum, na.rm = TRUE))

data_long_europe <- pivot_longer(h1b_europe, cols=-Country, names_to = "year", values_to = "count_h1b")

piecharts_europe <- list()

for(year_iter in unique(data_long_europe$year)){
  print(year_iter)
  europe_temp <- data_long_europe |> filter(year == year_iter)
  
  #choose top 5
  top_countries <- europe_temp |>
  group_by(Country) |>
  summarise(total_count = count_h1b) |>
  arrange(desc(total_count)) |>
  top_n(5)
  
  #summarise the rest
  other_countries <- europe_temp |>
  anti_join(top_countries, by = "Country") |>
    filter(!is.na(count_h1b))|>
  summarise(Country = "Other",
            total_count = sum(count_h1b))
  
  combined_data <- bind_rows(top_countries, other_countries)
  pie_chart <- pie(combined_data$total_count, labels = combined_data$Country, main = paste("Top 5 European Countries in", year_iter), col=viridis(length(combined_data$total_count)))
  
  piecharts_europe[[year_iter]] <- pie_chart
  
}
print(piecharts_europe)
```


```{r}
h1b_namerica <- h1b_country |>
  filter(Continent == 'North America') |>
  select(-Continent)
  #summarize(across(where(is.numeric), sum, na.rm = TRUE))

data_long_namerica <- pivot_longer(h1b_namerica, cols=-Country, names_to = "year", values_to = "count_h1b")

piecharts_namerica <- list()

for(year_iter in unique(data_long_namerica$year)){
  print(year_iter)
  namerica_temp <- data_long_namerica |> filter(year == year_iter)
  
  #choose top 5
  top_countries <- namerica_temp |>
  group_by(Country) |>
  summarise(total_count = count_h1b) |>
  arrange(desc(total_count)) |>
  top_n(5)
  
  #summarise the rest
  other_countries <- namerica_temp |>
  anti_join(top_countries, by = "Country") |>
    filter(!is.na(count_h1b))|>
  summarise(Country = "Other",
            total_count = sum(count_h1b))
  
  combined_data <- bind_rows(top_countries, other_countries)
  pie_chart <- pie(combined_data$total_count, labels = combined_data$Country, main = paste("Top 5 North American Countries in", year_iter), col=viridis(length(combined_data$total_count)))
  
  piecharts_namerica[[year_iter]] <- pie_chart
  
}
print(piecharts_namerica)
```

```{r}
h1b_samerica <- h1b_country |>
  select(-Continent)
  #summarize(across(where(is.numeric), sum, na.rm = TRUE))

data_long_samerica <- pivot_longer(h1b_samerica, cols=-Country, names_to = "year", values_to = "count_h1b")

piecharts_samerica <- list()

for(year_iter in unique(data_long_samerica$year)){
  print(year_iter)
  samerica_temp <- data_long_samerica |> filter(year == year_iter)
  
  #choose top 5
  top_countries <- samerica_temp |>
  group_by(Country) |>
  summarise(total_count = count_h1b) |>
  arrange(desc(total_count)) |>
  top_n(5)
  
  #summarise the rest
  other_countries <- samerica_temp |>
  anti_join(top_countries, by = "Country") |>
    filter(!is.na(count_h1b))|>
  summarise(Country = "Other",
            total_count = sum(count_h1b))
  
  combined_data <- bind_rows(top_countries, other_countries)
  pie_chart <- pie(combined_data$total_count, labels = combined_data$Country, main = paste("Top 5 South American Countries in", year_iter), col=viridis(length(combined_data$total_count)))
  
  piecharts_samerica[[year_iter]] <- pie_chart
  
}
print(piecharts_samerica)
```

```{r}
h1b_oceania <- h1b_country |>
  filter(Continent == 'Oceania') |>
  select(-Continent)
  #summarize(across(where(is.numeric), sum, na.rm = TRUE))

data_long_oceania <- pivot_longer(h1b_oceania, cols=-Country, names_to = "year", values_to = "count_h1b")

piecharts_oceania <- list()

for(year_iter in unique(data_long_oceania$year)){
  print(year_iter)
  oceania_temp <- data_long_oceania |> filter(year == year_iter)
  
  #choose top 5
  top_countries <- oceania_temp |>
  group_by(Country) |>
  summarise(total_count = count_h1b) |>
  arrange(desc(total_count)) |>
  top_n(3)
  
  #summarise the rest
  other_countries <- oceania_temp |>
  anti_join(top_countries, by = "Country") |>
    filter(!is.na(count_h1b))|>
  summarise(Country = "Other",
            total_count = sum(count_h1b))
  
  combined_data <- bind_rows(top_countries, other_countries)
  pie_chart <- pie(combined_data$total_count, labels = combined_data$Country, main = paste("Top 5 Oceanian Countries in", year_iter), col=viridis(length(combined_data$total_count)))
  
  piecharts_oceania[[year_iter]] <- pie_chart
  
}
print(piecharts_oceania)
```

```{r}
h1b_other <- h1b_country |>
  filter(Continent == 'Unknown') |>
  select(-Continent)
  #summarize(across(where(is.numeric), sum, na.rm = TRUE))

data_long_other <- pivot_longer(h1b_other, cols=-Country, names_to = "year", values_to = "count_h1b")

data_long_other
```



=======
```{r}
# Load libraries and dataset
suppressPackageStartupMessages(library(tidyverse))
h1b_country <- read_rds('dataset/cleaned_h1b_data.rds')
```

```{r}
# Rename year columns
years <- paste0(1997:2022)
colnames(h1b_country) <- c('Country', 'Continent', years)
```

```{r}
# Summarize total H1B visas per year and transform into long format for plotting
total_h1b_by_year_long <- h1b_country %>%
  select(all_of(years)) %>%
  summarise(across(everything(), sum, na.rm = TRUE)) %>%
  pivot_longer(cols = everything(), names_to = "year", values_to = "Total_H1B_Visas")

# Plot total H1B visas issued worldwide over the years
ggplot(total_h1b_by_year_long, aes(x = year, y = Total_H1B_Visas)) +
  geom_bar(stat = "identity") +
  labs(title = "Total H1B Visas Issued Worldwide Over the Years",
       x = "Year", y = "Total Number of H1B Visas") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1), legend.position = "none")
```

```{r}
# Summarize data by continent and transform into long format
data_long <- h1b_country %>%
  group_by(Continent) %>%
  summarise(across(all_of(years), sum, na.rm = TRUE)) %>%
  pivot_longer(cols = all_of(years), names_to = "year", values_to = "count_h1b")

# Plot total values by continent over the years
ggplot(data_long, aes(x = year, y = count_h1b, fill = Continent)) +
  geom_bar(stat = "identity") +
  facet_wrap(~Continent, scales="free_y") +
  scale_x_discrete(guide = guide_axis(check.overlap = TRUE)) +
  labs(title = "Total H1B Visas by Continent Over the Years",
       x = "Year", y = "Total Visas") +
  theme(legend.position = "top", axis.text.x = element_text(angle = 45, hjust = 1),
        plot.margin = unit(c(1, 1, 1, 1), "cm"))
```





>>>>>>> 5dcbcb76829b43c5323c8d54ece3b8995ca08211
