```{r}
suppressPackageStartupMessages(library(tidyverse))
h1b_country <- 
  read_rds('dataset/cleaned_h1b_data.rds')
```

```{r}
current_names <- names(h1b_country)
years <- paste0(seq(1997, 2022))
colnames(h1b_country) <- c('Country', 'Continent', years)
h1b_continent <- h1b_country |>
  group_by(Continent)|>
  select(-Country) |>
  summarize(across(everything(), sum, na.rm = TRUE))

library(tidyr)
data_long <- pivot_longer(h1b_continent, cols = -Continent, names_to = "year", values_to = "count_h1b")
data_long
```

```{r}
ggplot(data_long, aes(x = year, y = count_h1b, fill = Continent)) +
  geom_bar(stat = "identity", position = "stack") +
  facet_wrap(~Continent, scales="free_y") +
  labs(title = "Total Values by Continent Over the Years",
       x = "Year", y = "Total Value") + theme(legend.position = "top",
        axis.text.x = element_text(angle = 45, hjust = 1))
```
```{r}
yearly_totals <- data_long %>%
  group_by(year) %>%
  summarize(total_per_year = sum(count_h1b), .groups = 'drop')  # Ensure no grouping is carried over

data_long_enriched <- data_long %>%
  left_join(yearly_totals, by = "year")

data_long_enriched <- data_long_enriched %>%
  mutate(percentage_of_total = count_h1b / total_per_year)

data_long_enriched$year <- factor(data_long_enriched$year, levels = unique(data_long_enriched$year))

ggplot(data_long_enriched, aes(x = year, y = percentage_of_total, fill = Continent)) +
  geom_bar(stat = "identity", position = "dodge") +
  facet_wrap(~Continent, scales="free_y") +
  scale_y_continuous(labels = scales::percent_format(accuracy = 0.1)) +
  labs(title = "Percentage of Total Values by Continent Over the Years",
       x = "Year", y = "Share of Total H1B Visas (%)") +
  theme(legend.position = "top",
        axis.text.x = element_text(angle = 45, hjust = 1))
```

